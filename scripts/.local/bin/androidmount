#!/bin/sh

MOUNT_DIR="$HOME/mount"

print_err() {
  err=$1
  echo "Error: $1" >&2
  echo "Enter [dmount --help] for help"
  exit 1
}

if ! type "aft-mtp-mount" >/dev/null; then
  print_err "aft-mtp-mount not found"
  exit 1
fi

print_help() {
  help="androidmount: A command-line tool for safely mounting Android devices over MTP to $MOUNT_DIR/<mountpoint> with user ownership.

Usage:
    androidmount <mountpoint>

Arguments:
    mountpoint     The name of the mount directory inside $MOUNT_DIR (e.g., myphone).

Options:
    --help         Show this help message and exit.

Examples:
    • Mount an Android device to $MOUNT_DIR/phone:
        androidmount phone

    • Automatically create $MOUNT_DIR/myandroid and mount the device:
        androidmount myandroid

Notes:
    • This script uses 'aft-mtp-mount' to mount Android devices over MTP.
    • The mountpoint directory will be created if it does not exist.
    • The script checks if the mountpoint is already in use before mounting.
"

  if type "less" >/dev/null; then
    echo "$help" | less
  else
    echo "$help"
  fi
}

if ! [ -d "$MOUNT_DIR" ]; then
  mkdir -p "$MOUNT_DIR"
fi

if [ "$1" = "--help" ]; then
  print_help
  exit 0
fi

mountpoint=$1

if [ -z "$mountpoint" ]; then
  print_err "Mountpoint is empty"
fi

mountpoint="$MOUNT_DIR/$mountpoint"

if mountpoint -q "$mountpoint"; then
  print_err "$mountpoint is already a mountpoint!!"
fi

if ! [ -d "$mountpoint" ]; then
  mkdir -p "$mountpoint"
fi

aft-mtp-mount "$mountpoint"
