#!/usr/bin/env bash
set -eu

DIRECTORIES="$HOME/projects"
ROFI_CMD=(rofi -dmenu -i -p)
FZF_CMD=(fzf -i --wrap --wrap-sign=" " --prompt)
TMUX_TERMINAL_CLIENT_NAME="xterm-256color"
TERMINAL="${TERMINAL:-alacritty}"
TERMINAL_CMD="$TERMINAL -e"

has_tty() {
  [ -t 0 ] && [ -t 1 ]
}

selected_dir=""
session_name=""

launched_through_term=false
menu_cmd="${ROFI_CMD[@]}"

if has_tty; then
  launched_through_term=true
  menu_cmd="${FZF_CMD[@]}"
fi

# flags
new_term=false

while getopts ":n" opt; do
  case "$opt" in
  n) new_term=true ;;
  esac
done
shift $((OPTIND - 1))

# selecting the session with fuzzy find
if [ $# -eq 1 ]; then
  selected_dir=$1
else
  find_res=$(find $DIRECTORIES -mindepth 1 -maxdepth 1 -type d)

  declare -a dirs=()
  for f in $find_res; do
    dirs+=("${f##$HOME/}")
  done
  dirs+=(".dotfiles")
  dirs+=(".config")
  dirs+=("documents/notes")
  dirs+=("default")

  selected_dir=$(printf "%s\n" "${dirs[@]}" | $menu_cmd "Select: ")
fi

# select between the default session or ordinary session
if [ "$selected_dir" == "default" ]; then
  session_name="default"
  session_dir="$HOME"
else
  session_name=$(basename "$selected_dir")
  session_name="${session_name//./}"
  session_dir="$HOME/$selected_dir"
fi

# null check
[ -z "$selected_dir" ] && exit 0
[ -z "$session_name" ] && exit 0

# create session if doesn't exist
if ! tmux has-session -t="$session_name" 2>/dev/null; then
  tmux new-session -ds "$session_name" -c "$session_dir"
fi

# create a new terminal and attach to the session if new_term is enabled
if $new_term; then
  $TERMINAL_CMD tmux attach -t "${session_name}"
  exit 0
fi

# if the script is launched through a terminal
if $launched_through_term; then
  # switch to session if terminal has active tmux session
  if [ "${TMUX-}" ]; then
    tmux switch-client -t "${session_name}"

  # otherwise attach
  else
    tmux attach -t "${session_name}"
  fi

  exit 0
fi

# clients list
clients="$(
  tmux list-clients -F '#{client_tty} #{client_termname} #{session_name}' 2>/dev/null |
    awk -v term="$TMUX_TERMINAL_CLIENT_NAME" '$2 == term {print $1, $3}'
)"

count=0

if [ -n "$clients" ]; then
  count=$(printf '%s\n' "$clients" | wc -l)
fi

# if there is no client, then create a new terminal and attach to the session
if [ "$count" -eq 0 ]; then
  $TERMINAL_CMD tmux attach -t "${session_name}"
  exit 0

# if there is only one client, just select that one
elif [ "$count" -eq 1 ]; then
  client_tty=$(printf '%s\n' "$clients" | awk '{print $1}')

# if there is more than one client, select a switching one with fuzzy find
else
  notify-send -u critical -t 3000 "Multiple session instances are running, select a running session to switch it..."
  selected_session="$(
    printf '%s\n' "$clients" |
      awk '{print $2}' |
      sort -u |
      $menu_cmd "Select Switch Session: "
  )"

  [ -z "$selected_session" ] && exit 0

  client_tty="$(
    printf '%s\n' "$clients" |
      awk -v s="$selected_session" '$2 == s {print $1; exit}'
  )"
fi

# switch the chosen client to the chosen session
if [ -n "${client_tty}" ]; then
  tmux switch-client -c "${client_tty}" -t "${session_name}"
  exit 0
fi
