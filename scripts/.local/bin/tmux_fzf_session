#!/usr/bin/env bash
set -eu

DIRS=(
  "$HOME/documents/notes"
  "$HOME/documents/projects"
)

PREFS=(
  "note"
  "proj"
)

SUBS=(
  "$HOME/documents/"
  "$HOME/documents/"
)

EXTRA_DIRS=(
  ".dotfiles"
  ".config"
  "default"
)

CACHE_DIR="${XDG_CACHE_HOME:-$HOME/.cache}/tmux-sessionizer"
CACHE_FILE="$CACHE_DIR/sessions.cache"
META_FILE="$CACHE_DIR/meta.cache"

mkdir -p "$CACHE_DIR"

ROFI_CMD=(rofi -dmenu -i -p)
FZF_CMD=(fzf -i --wrap --wrap-sign=" " --prompt)
TMUX_TERMINAL_CLIENT_NAME="xterm-256color"
TERMINAL="${TERMINAL:-alacritty}"
TERMINAL_CMD="$TERMINAL -e"

has_tty() {
  [ -t 0 ] && [ -t 1 ]
}

config_hash() {
  printf '%s\n' \
    "${DIRS[@]}" \
    "${PREFS[@]}" \
    "${SUBS[@]}" \
    "${EXTRA_DIRS[@]}" |
    sha256sum | awk '{print $1}'
}

dirs_mtime() {
  local sum=""
  for d in "${DIRS[@]}"; do
    sum+=$(stat -c '%Y' "$d" 2>/dev/null || echo 0)
  done
  echo "$sum"
}

rebuild_cache() {
  : >"$CACHE_FILE"

  for i in "${!DIRS[@]}"; do
    base="${DIRS[$i]}"
    pref="${PREFS[$i]}"
    sub="${SUBS[$i]}"

    find "$base" -mindepth 1 -maxdepth 1 -type d | while read -r d; do
      display="${d#$sub}"
      session="${pref}--$(basename "$d")"
      session="${session//./}"
      printf '%s|%s|%s\n' "$display" "$session" "$d" >>"$CACHE_FILE"
    done
  done

  for d in "${EXTRA_DIRS[@]}"; do
    if [ "$d" = "default" ]; then
      display="default"
      session="default"
      dir="$HOME"
    else
      display="$d"
      session="${d//./}"
      dir="$HOME/$d"
    fi
    printf '%s|%s|%s\n' "$display" "$session" "$dir" >>"$CACHE_FILE"
  done

  printf '%s\n%s\n' "$(config_hash)" "$(dirs_mtime)" >"$META_FILE"
}

cache_valid() {
  [ -f "$CACHE_FILE" ] && [ -f "$META_FILE" ] || return 1
  read -r old_hash <"$META_FILE"
  old_mtime=$(sed -n '2p' "$META_FILE")
  [ "$old_hash" = "$(config_hash)" ] && [ "$old_mtime" = "$(dirs_mtime)" ]
}

if ! cache_valid; then
  rebuild_cache
fi

selected_dir=""
session_name=""

launched_through_term=false
menu_cmd="${ROFI_CMD[@]}"

if has_tty; then
  launched_through_term=true
  menu_cmd="${FZF_CMD[@]}"
fi

# flags
new_term=false

while getopts ":n" opt; do
  case "$opt" in
  n) new_term=true ;;
  esac
done
shift $((OPTIND - 1))

# selecting the session with fuzzy find
if [ $# -eq 1 ]; then
  selected_dir=$1
else
  selected_dir="$(
    cut -d'|' -f1 "$CACHE_FILE" | $menu_cmd "Select: "
  )"
fi

# select between the default session or ordinary session
if [ "$selected_dir" == "default" ]; then
  session_name="default"
  session_dir="$HOME"
else
  read -r _ session_name session_dir <<<"$(
    awk -F'|' -v s="$selected_dir" '$1 == s {print $1, $2, $3; exit}' "$CACHE_FILE"
  )"
fi

# null check
[ -z "$selected_dir" ] && exit 0
[ -z "$session_name" ] && exit 0

# create session if doesn't exist
if ! tmux has-session -t="$session_name" 2>/dev/null; then
  tmux new-session -ds "$session_name" -c "$session_dir"
fi

# create a new terminal and attach to the session if new_term is enabled
if $new_term; then
  $TERMINAL_CMD tmux attach -t "${session_name}"
  exit 0
fi

# if the script is launched through a terminal
if $launched_through_term; then
  # switch to session if terminal has active tmux session
  if [ "${TMUX-}" ]; then
    tmux switch-client -t "${session_name}"

  # otherwise attach
  else
    tmux attach -t "${session_name}"
  fi

  exit 0
fi

# clients list
clients="$(
  tmux list-clients -F '#{client_tty} #{client_termname} #{session_name}' 2>/dev/null |
    awk -v term="$TMUX_TERMINAL_CLIENT_NAME" '$2 == term {print $1, $3}'
)"

count=0

if [ -n "$clients" ]; then
  count=$(printf '%s\n' "$clients" | wc -l)
fi

# if there is no client, then create a new terminal and attach to the session
if [ "$count" -eq 0 ]; then
  $TERMINAL_CMD tmux attach -t "${session_name}"
  exit 0

# if there is only one client, just select that one
elif [ "$count" -eq 1 ]; then
  client_tty=$(printf '%s\n' "$clients" | awk '{print $1}')

# if there is more than one client, select a switching one with fuzzy find
else
  notify-send -u critical -t 3000 "Multiple session instances are running, select a running session to switch it..."
  selected_session="$(
    printf '%s\n' "$clients" |
      awk '{print $2}' |
      sort -u |
      $menu_cmd "Select Switch Session: "
  )"

  [ -z "$selected_session" ] && exit 0

  client_tty="$(
    printf '%s\n' "$clients" |
      awk -v s="$selected_session" '$2 == s {print $1; exit}'
  )"
fi

# switch the chosen client to the chosen session
if [ -n "${client_tty}" ]; then
  tmux switch-client -c "${client_tty}" -t "${session_name}"
  exit 0
fi
