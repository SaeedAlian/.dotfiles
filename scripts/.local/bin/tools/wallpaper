#!/usr/bin/env bash
set -e

require_vars \
  WALLPAPERS_DIR \
  LOCKSCREENS_DIR \
  START_LOCKSCREEN_SCRIPT_PATH \
  BACKGROUND_SCRIPT_PATH \
  DOTFILES_DIR \
  CORECONFIG_DIR

mkdir -p $WALLPAPERS_DIR
mkdir -p $LOCKSCREENS_DIR

TEMP_DIR="/tmp/wallpaper_script_tmp_dir"
WALLPAPERS_TEMP_DIR="$TEMP_DIR/walls"
LOCKSCREENS_TEMP_DIR="$TEMP_DIR/lockscreens"

print_err() {
  err=$1
  echo "Error: $1" >&2
  echo "Enter [$(basename "$0") --help] for help"
  exit 1
}

print_help() {
  help="A command-line tool to manage wallpapers and lockscreen images.

Usage:

  $(basename "$0") <command> [arguments]

Commands:

  add <file_path> <prefix>       Add a new wallpaper image. Converts to jpg if necessary and creates a lockscreen image.

  create-lockscreen <name>       Create a lockscreen image for an existing wallpaper.

  set-lockscreens                Generate lockscreen images for all wallpapers that don't have one.

  set <name>                     Set the current wallpaper by name.

  mode <center|max|tile|fill>    Set the display mode for the wallpaper.

  cleanlock                      Remove lockscreen images that no longer have corresponding wallpapers.

  resetnumber                    Reset numbering of wallpapers and lockscreen images.

Options:

  --help, -h                     Show this help message and exit.

Examples:

  # Add a new wallpaper image
  $(basename "$0") add ~/Downloads/mywall.png nature

  # Set a wallpaper as background
  $(basename "$0") set nature_1

  # Create a lockscreen image for an existing wallpaper
  $(basename "$0") create-lockscreen nature_1

  # Set lockscreen images for all wallpapers
  $(basename "$0") set-lockscreens

  # Change wallpaper display mode to fill
  $(basename "$0") mode fill

  # Cleanup old lockscreen images
  $(basename "$0") cleanlock

  # Reset numbering of wallpapers and lockscreens
  $(basename "$0") resetnumber

Notes:
 • Wallpapers are stored in $WALLPAPERS_DIR.
 • Lockscreens are stored in $LOCKSCREENS_DIR.
 • This script uses ffmpeg to convert and blur images for lockscreen creation.
 • Requires write access to the directories above.
 • This script depends on tools like 'sed', and 'xss-lock'.
"

  if type "less" >/dev/null; then
    echo "$help" | less
  else
    echo "$help"
  fi
}

# selects an image inside WALLPAPERS directory and creates a lockscreen image based on it
create_lockscreen_image() {
  image_name=$1
  silent_flag=$2
  image_path="$WALLPAPERS_DIR/$image_name.jpg"

  if [ ! -f "$image_path" ]; then
    print_err "Wallpaper with name: $image_name doesn't exist inside wallpapers directory."
  fi

  extension=${image_path##*.}
  mimetype=$(file -b --mime-type "$image_path" | sed 's/\/.*//g')

  if [ "$mimetype" != "image" ] || [ "$extension" != "jpg" ]; then
    print_err "Selected file $image_name is not an image or is not jpg."
  fi

  image_basename=${image_name%.*}

  lockscreen_path=$LOCKSCREENS_DIR/$image_basename.png

  if [ -f "$lockscreen_path" ]; then
    [ "$silent_flag" -eq 0 ] && echo "Lockscreen of image $image_name already exists."
  else
    [ "$silent_flag" -eq 0 ] && echo "Creating lockscreen image..."
    ffmpeg -i "$image_path" -vf "scale=1920:1080, boxblur=15" "$lockscreen_path" -loglevel error
    [ "$silent_flag" -eq 0 ] && echo "Lockscreen image of $image_name has been created successfully."
  fi
}

# creates lockscreen image with all the images inside the WALLPAPERS directory
# (if there is not a lockscreen image exists)
set_all_lockscreens() {
  echo "Creating lockscreen image for all wallpapers..."

  for file in "$WALLPAPERS_DIR"/*; do
    if [ -f "$file" ]; then
      filename=${file##*/}
      wallname=${filename%.*}
      create_lockscreen_image "$wallname" 1
    fi
  done

  echo "Lockscreen images have been created successfully."
}

# converts an image to jpg and moves it into WALLPAPERS directory
add_wall_image() {
  image_path=$1
  new_image_prefix=$2

  if [ ! -f "$image_path" ]; then
    print_err "File doesn't exist."
  fi

  extension=${image_path##*.}
  mimetype=$(file -b --mime-type "$image_path" | sed 's/\/.*//g')

  if [ "$mimetype" != "image" ]; then
    print_err "Selected file is not an image."
  fi

  index=0
  for f in "$WALLPAPERS_DIR"/*.jpg; do
    [ -f "$f" ] || continue
    fname=$(basename "$f")
    prefix=${fname%_*}

    if [ "$prefix" == "$new_image_prefix" ]; then
      index=$((index + 1))
    fi
  done

  new_image_name="${new_image_prefix}_$((index + 1))"

  if [ "$extension" = "jpg" ]; then
    echo "Copying image into wallpapers directory..."
    cp "$image_path" "$WALLPAPERS_DIR/$new_image_name.jpg"
    echo "Wallpaper image is moved into wallpapers directory successfully."
  else
    echo "File is not jpg, converting to jpg..."
    ffmpeg -i "$image_path" "$WALLPAPERS_DIR/$new_image_name.jpg" -loglevel error
    echo "Wallpaper image converted into jpg, and moved into wallpapers directory successfully."
  fi

  create_lockscreen_image "$new_image_name" 0
}

# sets the background variable name
set_background() {
  image_name=$1
  image_path=$WALLPAPERS_DIR/$image_name.jpg

  if [ ! -f "$image_path" ]; then
    print_err "Wallpaper with name: $image_name.jpg doesn't exist inside wallpapers directory."
  fi

  extension=${image_path##*.}
  mimetype=$(file -b --mime-type "$image_path" | sed 's/\/.*//g')

  if [ "$mimetype" != "image" ] || [ "$extension" != "jpg" ]; then
    print_err "Selected file $image_name is not an image or is not jpg."
  fi

  sed -i "s/BACKGROUND_PIC_NAME=.*/\BACKGROUND_PIC_NAME=\"$image_name\"/" "$CORECONFIG_DIR/background.conf"

  echo "Scripts updated."
  $BACKGROUND_SCRIPT_PATH &
  pkill xss-lock
  xss-lock -l -- "$START_LOCKSCREEN_SCRIPT_PATH" &
  echo "Wallpaper updated successfully."
}

# sets the background mode
set_background_mode() {
  image_bg_mode=$1

  if [ "$image_bg_mode" != "center" ] && [ $image_bg_mode != "max" ] && [ $image_bg_mode != "tile" ] && [ $image_bg_mode != "fill" ]; then
    print_err "Wrong option"
  fi

  sed -i "s/BACKGROUND_PIC_MODE=.*/\BACKGROUND_PIC_MODE=\"--bg-$image_bg_mode\"/" "$CORECONFIG_DIR/background.conf"

  echo "Scripts updated."
  $BACKGROUND_SCRIPT_PATH &
  echo "Wallpaper updated successfully."
}

# remove the lockscreens which there is no wallpaper of them in the wallpapers directory
cleanup_lockscreens() {
  for f in "$LOCKSCREENS_DIR"/*; do
    filename=$(basename "$f")
    wallfilename=$(echo "$filename" | sed "s/\.png/\.jpg/")
    if ! [ -f "$WALLPAPERS_DIR/$wallfilename" ]; then
      rm "$f"
    fi
  done
}

# resets the numbering order of the wallpapers and lockscreens
reset_wallpaper_numbers() {
  echo "Resetting wallpaper numbers..."

  if ! [ -d "$LOCKSCREENS_TEMP_DIR" ]; then
    mkdir -p "$LOCKSCREENS_TEMP_DIR"
  fi

  if ! [ -d "$WALLPAPERS_TEMP_DIR" ]; then
    mkdir -p "$WALLPAPERS_TEMP_DIR"
  fi

  for f in "$WALLPAPERS_TEMP_DIR"/*.jpg; do
    if [ -f "$f" ]; then
      rm "$f"
    fi
  done

  for f in "$LOCKSCREENS_TEMP_DIR"/*.png; do
    if [ -f "$f" ]; then
      rm "$f"
    fi
  done

  declare -A index
  for f in "$WALLPAPERS_DIR"/*.jpg; do
    [ -f "$f" ] || continue
    fname=$(basename "$f")
    prefix=${fname%_*}

    i=${index["$prefix"]}
    [ -z "$i" ] && i=0
    i=$((i + 1))
    index["$prefix"]=$i

    new_wall="$WALLPAPERS_TEMP_DIR/${prefix}_${i}.jpg"
    new_lock="$LOCKSCREENS_TEMP_DIR/${prefix}_${i}.png"
    old_lock="$LOCKSCREENS_DIR/${fname%.jpg}.png"

    cp "$f" "$new_wall"
    cp "$old_lock" "$new_lock"
  done

  for f in "$WALLPAPERS_DIR"/*.jpg; do
    if [ -f "$f" ]; then
      rm "$f"
    fi
  done

  for f in "$LOCKSCREENS_DIR"/*.png; do
    if [ -f "$f" ]; then
      rm "$f"
    fi
  done

  for f in "$WALLPAPERS_TEMP_DIR"/*.jpg; do
    if [ -f "$f" ]; then
      mv "$f" "$WALLPAPERS_DIR"
    fi
  done

  for f in "$LOCKSCREENS_TEMP_DIR"/*.png; do
    if [ -f "$f" ]; then
      mv "$f" "$LOCKSCREENS_DIR"
    fi
  done

  rm -rf "$WALLPAPERS_TEMP_DIR"
  rm -rf "$LOCKSCREENS_TEMP_DIR"

  echo "Wallpaper numbers reset."
}

cmd=$1

case $cmd in
"--help" | "-h")
  print_help
  ;;
"add")
  shift 1
  file_path=$1
  wall_prefix=$2

  [ -z "$wall_prefix" ] && print_err "Wallpaper prefix not specified"
  [ -z "$file_path" ] && print_err "File path not specified"

  add_wall_image "$file_path" "$wall_prefix"
  ;;
"create-lockscreen")
  shift 1
  wall_name=$1

  [ -z "$wall_name" ] && print_err "Wallpaper name not specified"

  create_lockscreen_image "$wall_name" 0
  ;;
"set-lockscreens")
  read -p "Are you sure that you want to set all the lockscreen images? (y/n): " choice
  case "$choice" in
  y | Y)
    set_all_lockscreens
    ;;
  *)
    exit 0
    ;;
  esac
  ;;
"set")
  shift 1
  wall_name=$1

  [ -z "$wall_name" ] && print_err "Wallpaper name not specified"

  set_background "$wall_name"
  ;;
"mode")
  shift 1
  wall_mode=$1

  [ -z "$wall_mode" ] && print_err "Wallpaper mode not specified"

  set_background_mode "$wall_mode"
  ;;
"cleanlock")
  read -p "Do you want to remove all extra lockscreens? (y/n): " choice
  case "$choice" in
  y | Y)
    cleanup_lockscreens
    ;;
  *)
    exit 0
    ;;
  esac
  ;;
"resetnumber")
  read -p "Do you want to reset the wallpaper numbers? (y/n): " choice
  case "$choice" in
  y | Y)
    cleanup_lockscreens
    reset_wallpaper_numbers
    ;;
  *)
    exit 0
    ;;
  esac
  ;;
*)
  print_err "Invalid command $1"
  ;;
esac
