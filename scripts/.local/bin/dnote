#!/usr/bin/env bash
# ▗▄▄▄ ▗▖  ▗▖ ▗▄▖▗▄▄▄▖▗▄▄▄▖
# ▐▌  █▐▛▚▖▐▌▐▌ ▐▌ █  ▐▌
# ▐▌  █▐▌ ▝▜▌▐▌ ▐▌ █  ▐▛▀▀▘
# ▐▙▄▄▀▐▌  ▐▌▝▚▄▞▘ █  ▐▙▄▄▖
#
# Author: Saeed Alian (https://github.com/SaeedAlian)
#
# A script for managing notes with tmux and fzf
#
# Depends on:
#   tmux, fzf

NOTES_DIR=$HOME/documents/notes
PRIMARY_NOTE_FILENAME="primary"
DEFAULT_NOTE_DIR="defaults"
TMUX_SESSION_NAME="notes"
ED="$EDITOR"
TERMINAL="${TERMINAL:-alacritty}"
TERMINAL_FLOAT_CLASS="Alacritty-float"

print_err() {
  err=$1
  echo "Error: $1" >&2
  echo "Enter [dnote --help] for help"
  exit 1
}

if ! type "tmux" >/dev/null; then
  print_err "tmux is not installed"
fi

if ! type "fzf" >/dev/null; then
  print_err "fzf is not installed"
fi

if [ -z "$ED" ]; then
  ED="vim"
fi

print_help() {
  help="dnote - A command-line tool for managing notes in tmux sessions.

Usage:

  dnote <command> [options]

Commands:

  new-note <dirname> <filename>     Create/open a note file in a directory.

  new-dir <dirname>                 Create/open a directory in tmux.

  dir-fzf                           Fuzzy-select a directory using fzf and open it.

  file-fzf                          Fuzzy-select a file within a directory and open it.

  prompt                            Interactive mode: prompts for directory & filename.

  primary                           Toggle (open/close) the primary note in floating terminal.

Options:

  -t, --type [md|typ|tex]           Set note file extension (default: md).

  -h, --help                        Show this help message.

Defaults:

  Notes directory:     \$HOME/documents/notes

  Default note folder: defaults

  Primary note:        primary.md

  Editor:              \$EDITOR (fallback: vim)

  Tmux session prefix: notes-<dirname>

Examples:

  dnote new-note work meeting

  dnote new-note work ideas -t typ

  dnote new-dir journal

  dnote file-fzf work

  dnote dir-fzf

  dnote prompt

  dnote primary
"

  if command -v less >/dev/null 2>&1; then
    echo "$help" | less
  else
    echo "$help"
  fi
}

primary_note_template() {
  echo "# Personal Notes

## Work

> [!DANGER] IMPORTANT

### Tasks

- [ ] Task 1

### Ideas

- **Idea 1:**  
  Description or sketch

---

## Study

> [!DANGER] IMPORTANT

### Tasks

- [ ] Task 1

### Ideas

- **Idea 1:**  
  Description or sketch

---

## Personal

> [!DANGER] IMPORTANT

### Tasks

- [ ] Task 1

### Ideas

- **Idea 1:**  
  Description or sketch

---"
}

default_note_template() {
  title=$1
  d=$2
  subtitle=$3

  if [ -z "$subtitle" ]; then
    echo "$title - $d"
  else
    echo "$title - $d

$subtitle"
  fi
}

check_filename() {
  filename="$1"

  if [[ -z "$filename" ]]; then
    print_err "Filename cannot be empty"
  fi

  if grep -q '[\\\/\:\*\?\"\<\>\|]' <<<"$filename"; then
    print_err "Filename contains disallowed characters"
  fi

  if [[ "$filename" =~ ^[-_.] ]]; then
    print_err "Filename must not start with '.' or '-' or '_'"
  fi

  filename="${filename%% }"
  filename="${filename## }"

  if [[ "$filename" == *"$'\0'"* ]]; then
    print_err "Filename contains null bytes"
  fi

  if [[ ${#filename} -gt 255 ]]; then
    print_err "Filename exceeds 255 characters"
  fi
}

check_dirname() {
  dirname="$1"

  if [ -z "$dirname" ]; then
    print_err "Directory name is empty"
  fi

  if grep -q '[\\\/\:\*\?\"\<\>\|\;]' <<<"$dirname"; then
    print_err "Invalid directory name, directory name must not contain illegal characters"
  fi

  if [[ "$dirname" =~ ^[-_] ]]; then
    print_err "Invalid directory name, directory name must not start with '-' or '_'"
  fi

  if [[ "$dirname" == "." ]]; then
    print_err "Invalid directory name, directory name must not equal to '.'"
  fi

  if [[ "$dirname" == ".." ]]; then
    print_err "Invalid directory name, directory name must not equal to '..'"
  fi

  dirname="${dirname%% }"
  dirname="${dirname## }"

  if [[ "$dirname" == *"$'\0'"* ]]; then
    print_err "Directory name contains null bytes"
  fi

  if [[ ${#dirname} -gt 255 ]]; then
    print_err "Directory name exceeds 255 characters"
  fi
}

check_note_type() {
  note_type="$1"

  if [ -z "$note_type" ]; then
    print_err "Note type is empty"
  fi

  note_type="${note_type%% }"
  note_type="${note_type## }"

  case "$note_type" in
  md | typ | tex) ;;
  *)
    print_err "Note type must be in [md|typ|tex]."
    ;;
  esac
}

fzf_note_dirs() {
  retval=$(find "$NOTES_DIR" -mindepth 1 -maxdepth 1 -type d | sed 's/.*\///g' | fzf -e -i)
  echo $retval
}

fzf_notes() {
  dir=$1

  if ! [ -d "$NOTES_DIR/$dir" ]; then
    print_err "Directory doesn't exist"
  fi

  retval=$(
    find "$NOTES_DIR/$dir" -mindepth 1 -type f \( -name "*.typ" -o -name "*.tex" -o -name "*.md" \) |
      sed "s|^$NOTES_DIR/$dir/||" |
      fzf -e -i
  )
  echo $retval
}

create_note_dir() {
  dir=$1
  mkdir -p "$NOTES_DIR/$dir"
}

create_note() {
  dir=$1
  dirbasename=$(basename "$1")
  filename=$2
  filebasename=$(basename "$2")
  filebasename=${filebasename%.*}

  # 0 or empty is default, 1 is primary
  type=$3

  if [ -n "$type" ] && [[ $type == 1 ]]; then
    fullpath="$NOTES_DIR/$PRIMARY_NOTE_FILENAME.md"

    if [ ! -f "$fullpath" ]; then
      touch $fullpath
      primary_note_template >$fullpath
    fi
  else
    fullpath="$NOTES_DIR/$dir/$filename"
    d=$(date +%Y-%m-%d)

    if [ ! -f $fullpath ]; then
      touch $fullpath
      if [[ "$dir" == "$d" ]]; then
        title=$(echo "$filebasename" | tr '_-' ' ' | awk '{ for(i=1; i<=NF; i++) $i = toupper(substr($i,1,1)) substr($i,2) } 1')
        default_note_template $title $d "" >$fullpath
      else
        title=$(echo "$dirbasename" | tr '_-' ' ' | awk '{ for(i=1; i<=NF; i++) $i = toupper(substr($i,1,1)) substr($i,2) } 1')
        subtitle=$(echo "$filebasename" | tr '_-' ' ' | awk '{ for(i=1; i<=NF; i++) $i = toupper(substr($i,1,1)) substr($i,2) } 1')

        default_note_template $title $d $subtitle >$fullpath
      fi
    fi
  fi
}

attach_tmux() {
  dir=$(basename "$1")
  orig_filename=$2
  filename=""

  no_filename=0

  if [ -z "$dir" ]; then
    print_err "Directory must be specified"
  fi

  if ! [ -d "$NOTES_DIR/$dir" ]; then
    print_err "Directory doesn't exist"
  fi

  session_name="$TMUX_SESSION_NAME-$dir"

  if [ -z "$orig_filename" ]; then
    if ! tmux has-session -t="$session_name" 2>/dev/null; then
      tmux new-session -ds "$session_name" -c "$NOTES_DIR/$dir"
    fi

    if [ -z "$TMUX" ]; then
      tmux attach -t "$session_name"
    else
      tmux switch-client -t "$session_name"
    fi

    exit 0
  fi

  filename=$(basename "$2")
  filename=${filename%.*}

  if [ -z "$filename" ]; then
    print_err "Filename must be specified"
  fi

  window="$session_name:$filename"
  pane="${window}.0"

  if ! tmux has-session -t="$session_name" 2>/dev/null; then
    tmux new-session -ds "$session_name" -c "$NOTES_DIR/$dir" -n "$filename"
  else
    tmux new-window -S -n "$filename" -t "$session_name:" -c "$NOTES_DIR/$dir"
  fi

  tmux select-window -t "$session_name:$filename"
  current_cmd=$(tmux display-message -p -t "$pane" '#{pane_current_command}')

  if [ "$current_cmd" != "$ED" ]; then
    tmux send-keys -t "$pane" "$ED \"$NOTES_DIR/$dir/$orig_filename\"" Enter
  fi

  if [ ! -z "$TMUX" ]; then
    tmux switch-client -t "$session_name"
  else
    tmux attach-session -t "$session_name"
  fi

  exit 0
}

# check for help option
if [[ "$1" == "-h" ]] || [[ "$1" == "--help" ]]; then
  if [[ $# -gt 1 ]]; then
    print_err "[help flag] cannot be combined with other options"
  fi

  print_help
  exit 0
fi

mkdir -p "$NOTES_DIR"

dirname="$DEFAULT_NOTE_DIR"
filename=""
note_type="md"

if [[ $# -lt 1 ]]; then
  print_err "Empty arguments received"
fi

cmd=$1
shift 1

case $cmd in
new-note)
  dirname="$1"
  check_dirname "$dirname"
  filename="$2"
  check_filename "$filename"
  shift 2
  ;;

new-dir)
  dirname="$1"
  check_dirname "$dirname"
  shift 1
  ;;

file-fzf)
  dirname=$(fzf_note_dirs)
  if [ -z "$dirname" ]; then
    echo "Operation cancelled"
    exit 0
  fi

  check_dirname "$dirname"
  filename=$(fzf_notes "$dirname")

  if [ -z "$filename" ]; then
    echo "Operation cancelled"
    exit 0
  fi

  check_filename "$filename"
  attach_tmux "$dirname" "$filename"
  exit 0
  ;;

dir-fzf)
  dirname=$(fzf_note_dirs)
  if [ -z "$dirname" ]; then
    echo "Operation cancelled"
    exit 0
  fi

  check_dirname "$dirname"
  attach_tmux "$dirname" ""
  exit 0
  ;;

prompt)
  d=""
  f=""

  read -e -p "Enter Directory Name: (if empty it will use the default directory, type fzf for fuzzy find the directory) " -i "" d

  if [ ! -z "$d" ]; then
    if [[ "$d" == "fzf" ]]; then
      dirname=$(fzf_note_dirs)
      if [ -z "$dirname" ]; then
        echo "Operation cancelled"
        exit 0
      fi
    else
      dirname=$d
    fi
  fi

  check_dirname "$dirname"

  read -e -p "Enter Filename: " -i "" f
  check_filename "$f"
  filename="$f"
  ;;

primary)
  list_str=$(pgrep alacritty --list-full | grep -E "$TERMINAL --class "$TERMINAL_FLOAT_CLASS" -e $ED "$NOTES_DIR/$PRIMARY_NOTE_FILENAME.md"" | awk '{print $1}')
  pids=()

  IFS=$'\n'
  while read -r line; do
    pids+=("$line")
  done <<<"$list_str"

  pids_len=${#pids[@]}

  if [ -n "$list_str" ] && [ $pids_len -gt 0 ]; then
    for pid in ${pids[@]}; do
      kill "$pid"
    done

    exit 0
  fi

  create_note "" "" 1
  $TERMINAL --class "$TERMINAL_FLOAT_CLASS" -e $ED "$NOTES_DIR/$PRIMARY_NOTE_FILENAME.md"
  exit 0
  ;;
esac

while [[ $# -gt 0 ]]; do
  case $1 in
  -t | --type)
    note_type="$2"
    check_note_type "$note_type"
    shift 1
    ;;
  *)
    print_err "Invalid option $1"
    ;;
  esac
  shift 1
done

create_note_dir "$dirname"

if [[ -z "$filename" ]]; then
  attach_tmux "$dirname" ""
else
  filename="$filename.$note_type"
  create_note "$dirname" "$filename"
  attach_tmux "$dirname" "$filename"
fi

exit 0
